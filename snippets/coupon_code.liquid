<div class="mt-5">
  <input type="text" id="coupon-code" class="border-0 border-bottom rounded me-5 py-3 mb-4" placeholder="Coupon Code">
  <button
    id="apply_discount"
    class="btn border-secondary rounded-pill px-4 py-3 text-primary"
    onclick="applyDiscount()"
    type="button"
  >
    Apply Coupon
  </button>
  <button
    id="remove_discount"
    class="btn border-secondary rounded-pill px-4 py-3 text-danger"
    onclick="removeDiscount()"
    type="button"
    style="display:none"
  >
    Remove Coupon
  </button>
  <p class="mb-0 mt-4 text-danger" id="error_note" style="display:none">123</p>
</div>

<script>
  cartData();
  var code = document.getElementById('coupon-code');
  var error_note = document.getElementById('error_note');
  var applyDiscount = document.getElementById('apply_discount');
  var removeDiscount = document.getElementById('remove_discount');

  function removeDiscount() {
    fetch('/discount/CLEAR')
      .then(function (response) {
        return response.text();
      })
      .then(function (data) {
        cartData();
      });
  }

  function cartData() {
    fetch(window.Shopify.routes.root + 'cart.js', {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
      },
    })
      .then((response) => {
        return response.json();
      })
      .then((data) => {
        var discounts = data['items'][0]['discounts'];
        if (discounts.length && discounts[0]['title'] != '') {
          code.value = discounts[0]['title'];
          removeDiscount.style.display = 'block';
          applyDiscount.style.display = 'none';
        }
        //return data;
      })
      .catch((error) => {
        console.error('Error:', error);
      });
  }

  function applyDiscount() {
    error_note.style.display = 'none';
    if (code.value == '') {
      error_note.style.display = 'block';
      error_note.innerHTML = 'Coupon code is required!';
      return false;
    }
    let discountApplyUrl = window.location.href + '/checkout?discount=' + code.value + '&t=' + Date.now();
    fetch(discountApplyUrl)
      .then(function (response) {
        return response.json();
      })
      .then(function (data) {
        cartData();
      });
  }
</script>
